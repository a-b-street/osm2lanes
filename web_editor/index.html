<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
      .cards-row {
        display: flex;
        flex-direction: row;
      }

      .card {
        outline: solid;
        padding: 15px;
      }

      .card-being-dragged {
        background-color: #c8ebfb;
      }
    </style>

    <link data-trunk rel="rust" href="../osm2lanes-npm/Cargo.toml" />
    <link data-trunk rel="copy-dir" href="./js" />
    <script type="module" src="js/dummy_data.js"></script>
  </head>
  <body>
    <fieldset>
      <legend>OSM way ID</legend>
      <input type="text" id="osm_way_id" value="804788513" />
    </fieldset>
    <input type="button" value="Edit" onclick="window.start_editing();" />

    <div id="cards" class="cards-row">
      <div class="card">Item 1</div>
    </div>

    <div style="border: 3px solid; padding 20px; margin-top: 30px">
      <div
        id="delete"
        class="cards-row"
        style="
          float: left;
          margin-right: 50px;
          border: 2px dashed red;
          min-height: 100px;
          padding: 30px;
        "
      >
        Delete lane
      </div>

      <div id="toolbox" class="cards-row" style="float: left">
        <!-- TODO Can I just make up / overload the value attribute here? -->
        <div class="card" value="driving">New driving lane</div>
        <div class="card" value="bike">New bike lane</div>
        <div class="card" value="parking">New parking lane</div>
      </div>
    </div>

    <div style="margin-top: 90px">
      <input
        type="button"
        value="Generate output"
        onclick="window.generate_tags();"
      />
      <textarea id="output_tags" rows="10" cols="50">Output tags</textarea>
    </div>

    <script type="module">
      // TODO The hash changes, this is very brittle. See https://github.com/thedodd/trunk/issues/230 or stop using trunk.
      import { dummyData } from "./js/dummy_data.js";
      import init, {
        js_way_to_lanes,
        js_lanes_to_tags,
      } from "./osm2lanes-npm-34a13471983c341c.js";
      await init();

      // Setup the toolbox controls
      new Sortable(document.getElementById("toolbox"), {
        group: {
          name: "toolbox",
          pull: "clone",
        },
        sort: false,
        animation: 150,
        ghostClass: "card-being-dragged",
      });

      // TODO Disable the ghostClass of lanes when going here
      new Sortable(document.getElementById("delete"), {
        group: "lanes",
        onAdd: function (evt) {
          var el = evt.item;
          el.parentNode.removeChild(el);
        },
      });

      // This state is set up by start_editing
      var current_road = null;
      var current_locale = null;

      async function start_editing() {
        const way = BigInt(document.getElementById("osm_way_id").value);
        console.log(`Fetching ${way}...`);
        //const [road_wrapper, locale] = await js_way_to_lanes(way);
        const [road_wrapper, locale] = dummyData();
        const road = road_wrapper["Ok"]["road"];
        console.log(`Got osm2lanes output, creating cards`);

        current_road = JSON.parse(JSON.stringify(road));
        current_locale = JSON.parse(JSON.stringify(locale));

        // TODO Fully clean up the old cards, including whatever sortable thing is attached there
        const cards = document.getElementById("cards");
        cards.replaceChildren();

        // Create a card per lane
        for (const lane of road["lanes"]) {
          if (lane["type"] == "separator") {
            continue;
          }
          cards.appendChild(make_lane_card(lane));
        }

        new Sortable(cards, {
          group: {
            name: "lanes",
            put: ["toolbox"],
          },
          animation: 150,
          ghostClass: "card-being-dragged",
          onAdd: function (evt) {
            const type = evt.item.getAttribute("value");
            // TODO switch case but without break?
            // TODO Figure out based on center line position
            if (type == "driving") {
              evt.item.replaceWith(
                make_lane_card({
                  type: "travel",
                  direction: "backward",
                  designated: "motor_vehicle",
                })
              );
            } else if (type == "bike") {
            } else if (type == "parking") {
            }
          },
        });
      }
      window.start_editing = start_editing;

      function make_lane_card(lane) {
        var node = document.createElement("div");
        node.setAttribute("class", "card");
        node.setAttribute("title", JSON.stringify(lane, null, 2));
        node.laneJSON = lane;

        node.innerHTML = lane["type"];

        // TODO I want if-let
        {
          let x = lane["designated"];
          if (x) {
            node.innerHTML += `, ${x}`;
          }
        }

        {
          let x = lane["direction"];
          if (x == "forward") {
            node.innerHTML += ", ^";
          } else if (x == "backward") {
            node.innerHTML += ", v";
          } else if (x == "both") {
            node.innerHTML += ", |";
          }
        }

        {
          let x = lane["width"];
          if (x) {
            node.innerHTML += `, width = ${x}m`;
          }
        }

        return node;
      }

      function generate_tags() {
        // Mutate the shared state
        current_road["lanes"] = [];
        for (const card of document.getElementById("cards").children) {
          current_road["lanes"].push(card.laneJSON);
        }
        const tags = js_lanes_to_tags(current_road, current_locale);

        const output = document.getElementById("output_tags");
        output.value = tags;
      }
      window.generate_tags = generate_tags;
    </script>
  </body>
</html>

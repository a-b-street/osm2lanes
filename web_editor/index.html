<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
      .cards-row {
        display: flex;
        flex-direction: row;
      }

      .card {
        background-color: red;
        margin-left: 15px;
      }

      .card-being-dragged {
        background-color: #c8ebfb;
      }
    </style>

    <link data-trunk rel="rust" href="../osm2lanes-npm/Cargo.toml" />
    <link data-trunk rel="copy-dir" href="./js" />
    <script type="module" src="js/dummy_data.js"></script>
  </head>
  <body>
    <fieldset>
      <legend>OSM way ID</legend>
      <input type="text" id="osm_way_id" value="804788513" />
    </fieldset>
    <input type="button" value="Edit" onclick="window.start_editing();" />

    <div id="cards" class="cards-row">
      <div class="card">Item 1</div>
    </div>

    <script type="module">
      // TODO The hash changes, this is very brittle. See https://github.com/thedodd/trunk/issues/230 or stop using trunk.
      import { dummyData } from "./js/dummy_data.js";
      import init, {
        js_way_to_lanes,
      } from "./osm2lanes-npm-f84a742dc46ad4d0.js";
      await init();

      async function start_editing() {
        const way = BigInt(document.getElementById("osm_way_id").value);
        console.log(`Fetching ${way}...`);
        //let lanes = await js_way_to_lanes(way);
        let lanes = dummyData();
        console.log(`Got osm2lanes output, creating cards`);

        // TODO Fully clean up the old cards, including whatever sortable thing is attached there
        const cards = document.getElementById("cards");
        cards.replaceChildren();

        // Create a card per lane
        for (const lane of lanes["Ok"]["road"]["lanes"]) {
          if (lane["type"] == "separator") {
            continue;
          }
          cards.appendChild(make_lane_card(lane));
        }

        new Sortable(cards, {
          animation: 150,
          ghostClass: "card-being-dragged",
        });
      }

      function make_lane_card(lane) {
        var node = document.createElement("div");
        node.setAttribute("class", "card");
        node.setAttribute("title", JSON.stringify(lane, null, 2));
        node.innerHTML = lane["type"];
        return node;
      }

      window.start_editing = start_editing;
    </script>
  </body>
</html>
